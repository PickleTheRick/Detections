type: Microsoft.SecurityInsights/alertRules
kind: Scheduled
asurgent_id: 794d566e-bbf0-4e71-ae80-33e92a864676
properties:
  displayName: Multiple Malware detected on several endpoints
  description: |
    Alert rule to detect when multiple malwares are detected in the same environment. 
    This detection might indicate that several malwares was stopped from delivering its payload
    This might indicate a potential malware-outbreak.

    This rule is part of Asurgent CloudOps Security, https://asurgent.com
  tactics:
  - Initial Access
  - Execution
  techniques:
  - T1207
  - T1203
  - T1204
  severity: High
  alertDetailsOverride:
    # Alert Details Override make it possible to have dynamic display names, descriptions, tactics and severities for an alert by encapsulating column names in double brackets: {{columnName}}
    # For example:
    # alertDisplayNameFormat: {{accountEntity}} performed {{action}} on user {{targetAccount}}
    alertDisplayNameFormat:
    alertDescriptionFormat:
    alertTacticsColumnName:
    alertSeverityColumnName:
  enabled: true
  requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
    -  SecurityAlert
  query: | 
    let lookback = 30m;
    (union isfuzzy=true
        (SecurityEvent
        | where TimeGenerated >= ago(lookback)
        | where ProviderName contains "MDATP"
        | extend MicrosoftDefenderAtp_Category_ = tostring(parse_json(ExtendedProperties).["MicrosoftDefenderAtp.Category"])
        | where  MicrosoftDefenderAtp_Category_ contains "Malware" and where Displayname !contains “scheduled scan”
        | where AlertSeverity contains "High" or AlertSeverity contains "Medium"
        )

entityMappings:
    - fieldMappings:
      - identifier: FullName
        columnName: CompromisedEntity
      entityType: CompromisedEntity
    - fieldMappings:
      - identifier: FullName
        columnName: CompromisedEntity
      entityType: CompromisedEntity
    - fieldMappings:
      - identifier: CommandLine
        columnName: ProcessCommandLine
      - identifier: ProcessId
        columnName: ProcessIdCustomEntity
      entityType: Process
customDetails: {}
queryFrequency: PT30M
queryPeriod: PT30M
triggerOperator: GreaterThan
triggerThreshold: 0
eventGroupingSettings:
  aggregationKind: SingleAlert
suppressionEnabled: false
suppressionDuration: PT1H
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    lookbackDuration: PT1H
    groupByEntities:
    - Host
    groupByAlertDetails: []
    matchingMethod: Selected
    groupByCustomDetails: []
    reopenClosedIncident: true
tags:
- Asurgent CloudOps Security
- Multiple Malware

type: Microsoft.SecurityInsights/alertRules
kind: Scheduled
asurgent_id: 0759ff25-bacf-4e6c-880f-176f9e5e18e8
properties:
  displayName: Multiple exploits detected on several endpoints
  description: |
    Alert rule to detect when multiple exploits are detected in the same environment. 
    This indicates that several attempts to deploy malicious payload over the infrastructure has been detected.
    This might indicate a potential breach is happening.

    This rule is part of Asurgent CloudOps Security, https://asurgent.com
  tactics:
  - Initial Access
  - Execution
  techniques:
  - 
  severity: High
  alertDetailsOverride:
    # Alert Details Override make it possible to have dynamic display names, descriptions, tactics and severities for an alert by encapsulating column names in double brackets: {{columnName}}
    # For example:
    # alertDisplayNameFormat: {{accountEntity}} performed {{action}} on user {{targetAccount}}
    alertDisplayNameFormat:
    alertDescriptionFormat:
    alertTacticsColumnName:
    alertSeverityColumnName:
  enabled: true
  requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
    -  SecurityAlert
  query:
SecurityAlert
| summarize arg_max(TimeGenerated, *) by SystemAlertId
| where ProviderName contains "MDATP"
| extend MicrosoftDefenderAtp_Category_ = tostring(parse_json(ExtendedProperties).["MicrosoftDefenderAtp.Category"])
| where  MicrosoftDefenderAtp_Category_ contains "Exploit"

entityMappings:
  - fieldMappings:
    - identifier: FullName
      columnName: AccountUpn
    entityType: Account

  - fieldMappings:
    - identifier: CompromisedEntity
      columnName: CompromisedEntity
    entityType: CompromisedEntity

  - fieldMappings:
    - identifier: CommandLine
      columnName: ProcessCommandLine
    - identifier: ProcessId
      columnName: ProcessId
    entityType: Process
  # Custom details is a dictionary of key-value-pairs
  # To add a custom detail where the key name is 'suspisciousUrl' and the key value is stored in a column called 'phishUrl', add the following:
  # customDetails: { suspisciousUrl: phishUrl }
  # If no custom details should be added, replace the sample values with '{}':
  # customDetails: {}
  customDetails: {}
  queryFrequency: PT30M
  queryPeriod: PT30M
  triggerOperator: GreaterThan
  triggerThreshold: 4
  eventGroupingSettings:
    aggregationKind: SingleAlert
  suppressionEnabled: false
  suppressionDuration: PT30M
  incidentConfiguration:
    createIncident: true
    groupingConfiguration:
      enabled: true
      lookbackDuration: PT30M
      groupByEntities:
      - Host
      groupByAlertDetails: []
      matchingMethod: Selected
      groupByCustomDetails: []
      reopenClosedIncident: true
  tags:
  - Asurgent CloudOps Security
  - Multiple Exploits
